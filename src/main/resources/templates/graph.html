<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cacummaro - Smart Classification Graph</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .back-btn {
            position: fixed;
            top: 2rem;
            left: 2rem;
            background: white;
            color: #667eea;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .container {
            display: flex;
            gap: 2rem;
            max-width: 1800px;
            margin: 0 auto;
        }

        .graph-container {
            flex: 1 1 auto;
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            min-height: 600px;
            min-width: 600px;
        }

        .sidebar {
            flex: 0 0 450px;
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            max-height: 80vh;
            overflow-y: auto;
            overflow-x: hidden;
            display: none;
            min-width: 450px;
            max-width: 450px;
        }

        .sidebar.visible {
            display: block;
        }

        .sidebar h2 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .sidebar h3 {
            color: #667eea;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }

        .category-info {
            background: #f8f9ff;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            border: 2px solid #e1e5f7;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .document-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .document-item {
            background: #f8f9ff;
            padding: 1rem;
            border-radius: 10px;
            border: 2px solid #e1e5f7;
            transition: all 0.3s ease;
            cursor: pointer;
            overflow: hidden;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .document-item:hover {
            border-color: #667eea;
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .document-title {
            color: #333;
            font-weight: 600;
            margin-bottom: 0.3rem;
            font-size: 0.95rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            line-height: 1.4;
        }

        .document-url {
            color: #666;
            font-size: 0.8rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            line-height: 1.3;
            max-width: 100%;
        }

        .document-actions {
            margin-top: 0.5rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .download-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            font-size: 0.75rem;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        #graph {
            width: 100%;
            height: 600px;
        }

        .node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node circle {
            fill: #667eea;
            stroke: white;
            stroke-width: 3px;
        }

        .node.root circle {
            fill: #764ba2;
            r: 40;
        }

        .node:hover circle {
            fill: #764ba2;
            r: 35;
        }

        .node text {
            font-size: 12px;
            font-weight: 600;
            fill: #333;
            pointer-events: none;
        }

        .node.root text {
            font-size: 16px;
            fill: white;
        }

        .link {
            stroke: #999;
            stroke-opacity: 0.6;
            stroke-width: 2px;
        }

        .badge {
            background: #667eea;
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e1e5f7;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                max-height: none;
            }
        }
    </style>
</head>
<body>
    <a href="/" class="back-btn">‚Üê Back to Home</a>

    <div class="header">
        <h1>üß† Smart Classification Graph</h1>
        <p>Visual representation of document categories</p>
    </div>

    <div class="container">
        <div class="graph-container">
            <div id="loading" class="loading">
                <div class="loading-spinner"></div>
                <p>Loading categories...</p>
            </div>
            <div id="graph"></div>
        </div>

        <div id="sidebar" class="sidebar">
            <h2>
                <span id="selectedCategory">Select a category</span>
            </h2>
            <div id="categoryInfo"></div>
            <h3>Documents <span id="docCount" class="badge">0</span></h3>
            <div id="documentList" class="document-list"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1';
        let categories = [];
        let currentCategory = null;

        // Initialize the graph
        async function init() {
            try {
                console.log('Fetching categories from:', `${API_BASE}/categories`);
                const response = await fetch(`${API_BASE}/categories`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                categories = await response.json();
                console.log('Categories loaded:', categories);

                document.getElementById('loading').style.display = 'none';

                if (categories.length === 0) {
                    document.getElementById('graph').innerHTML = `
                        <div class="loading">
                            <p>No categories found yet. Ingest some documents first!</p>
                            <p style="font-size: 0.9rem; color: #666; margin-top: 1rem;">
                                Go back to the <a href="/" style="color: #667eea; text-decoration: underline;">home page</a>
                                and ingest a URL to create categories.
                            </p>
                        </div>
                    `;
                    return;
                }

                renderGraph(categories);
            } catch (error) {
                console.error('Error loading categories:', error);
                document.getElementById('loading').innerHTML = `
                    <p style="color: #d32f2f;">Error loading categories: ${error.message}</p>
                    <p style="font-size: 0.9rem; color: #666; margin-top: 1rem;">
                        Check the console for more details or
                        <a href="/" style="color: #667eea; text-decoration: underline;">go back to home</a>.
                    </p>
                `;
            }
        }

        // Render the graph using D3.js
        function renderGraph(categories) {
            console.log('renderGraph called with categories:', categories);

            const width = document.getElementById('graph').offsetWidth;
            const height = 600;

            console.log('Graph dimensions:', width, 'x', height);

            // Create root node
            const nodes = [
                { id: 'root', name: 'Categories', group: 0, count: categories.reduce((sum, c) => sum + (c.documentCount || 0), 0) }
            ];

            // Add category nodes
            categories.forEach((cat, i) => {
                nodes.push({
                    id: cat.name || cat.id,
                    name: cat.name || cat.id,
                    group: i + 1,
                    count: cat.documentCount || 0,
                    category: cat
                });
            });

            console.log('Nodes created:', nodes);

            // Create links from root to each category
            const links = categories.map(cat => ({
                source: 'root',
                target: cat.name || cat.id,
                value: cat.documentCount || 1
            }));

            console.log('Links created:', links);

            // Clear existing graph
            d3.select('#graph').selectAll('*').remove();

            // Check if D3 is loaded
            if (typeof d3 === 'undefined') {
                console.error('D3.js is not loaded!');
                document.getElementById('graph').innerHTML = '<p style="color: red; text-align: center;">D3.js failed to load. Check your internet connection.</p>';
                return;
            }

            console.log('D3.js version:', d3.version);

            // Create SVG
            const svg = d3.select('#graph')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // Create force simulation
            const simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(150))
                .force('charge', d3.forceManyBody().strength(-400))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(40));

            // Create links
            const link = svg.append('g')
                .selectAll('line')
                .data(links)
                .enter().append('line')
                .attr('class', 'link')
                .attr('stroke-width', d => Math.sqrt(d.value));

            // Create nodes
            const node = svg.append('g')
                .selectAll('g')
                .data(nodes)
                .enter().append('g')
                .attr('class', d => d.id === 'root' ? 'node root' : 'node')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended))
                .on('click', (event, d) => {
                    if (d.id !== 'root') {
                        selectCategory(d.category);
                    }
                });

            // Add circles to nodes
            node.append('circle')
                .attr('r', d => d.id === 'root' ? 40 : 30);

            // Add labels to nodes
            node.append('text')
                .text(d => d.name)
                .attr('text-anchor', 'middle')
                .attr('dy', d => d.id === 'root' ? '0.3em' : '-35px')
                .style('fill', d => d.id === 'root' ? 'white' : '#333');

            // Add count badges
            node.filter(d => d.id !== 'root')
                .append('text')
                .text(d => d.count)
                .attr('text-anchor', 'middle')
                .attr('dy', '0.3em')
                .style('fill', 'white')
                .style('font-weight', 'bold')
                .style('font-size', '14px');

            // Update positions on each tick
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                node.attr('transform', d => `translate(${d.x},${d.y})`);
            });

            // Drag functions
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
        }

        // Select a category and load its documents
        async function selectCategory(category) {
            console.log('selectCategory called with:', category);
            currentCategory = category;
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.add('visible');

            document.getElementById('selectedCategory').textContent = category.name || category.id;

            const categoryInfo = document.getElementById('categoryInfo');
            categoryInfo.innerHTML = `
                <div class="category-info">
                    <strong>Description:</strong> ${category.description || 'No description available'}<br>
                    <strong>Created:</strong> ${category.createdAt ? new Date(category.createdAt).toLocaleDateString() : 'N/A'}
                </div>
            `;

            // Show loading state
            const documentList = document.getElementById('documentList');
            documentList.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Loading documents...</p></div>';

            // Load documents for this category
            try {
                const categoryName = category.name || category.id;
                const url = `${API_BASE}/categories/${encodeURIComponent(categoryName)}/documents?size=20`;
                console.log('Fetching documents from:', url);

                const response = await fetch(url);
                console.log('Response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Documents data received:', data);

                const documents = data.content || [];
                console.log('Number of documents:', documents.length);

                document.getElementById('docCount').textContent = documents.length;

                if (documents.length === 0) {
                    documentList.innerHTML = '<p style="color: #666; text-align: center; padding: 2rem;">No documents in this category yet.</p>';
                    return;
                }

                documentList.innerHTML = documents.map(doc => {
                    // Sanitize filename for download attribute
                    const filename = (doc.pdfAttachmentName || 'document.pdf')
                        .replace(/[<>:"/\\|?*]/g, '_')
                        .substring(0, 200); // Limit filename length

                    // Get document ID (handle both _id and id fields from CouchDB)
                    const docId = doc._id || doc.id;

                    // Build the PDF URL
                    const pdfUrl = `${API_BASE}/documents/${encodeURIComponent(docId)}/pdf`;
                    console.log('PDF URL for', doc.title, ':', pdfUrl, 'Document ID:', docId);

                    return `
                        <div class="document-item">
                            <div class="document-title">${escapeHtml(doc.title || 'Untitled Document')}</div>
                            <div class="document-url">${escapeHtml(doc.url || '')}</div>
                            <div class="document-actions">
                                <a href="${pdfUrl}"
                                   class="download-btn"
                                   download="${filename}"
                                   onclick="console.log('Downloading:', '${pdfUrl}'); return true;"
                                   target="_blank">
                                    üìÑ Download PDF
                                </a>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading documents:', error);
                documentList.innerHTML = `
                    <p style="color: #d32f2f; text-align: center; padding: 2rem;">
                        Error loading documents: ${error.message}
                    </p>
                    <p style="color: #666; text-align: center; font-size: 0.9rem;">
                        Check the browser console for more details.
                    </p>
                `;
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize on page load
        init();
    </script>
</body>
</html>